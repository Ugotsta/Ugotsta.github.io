<!doctype html>
<html lang="en">

<head>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <script src="//cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.5/p5.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.5/addons/p5.sound.min.js"></script>
    <script src="//connect.soundcloud.com/sdk.js"></script>
    <script>
        var myp5;
        var sound;
        var client_id = 'ea6d4c6a6f367767516c9221a30c2ced';
        
        // thanks to David Morales here: http://stackoverflow.com/questions/11582512/how-to-get-url-parameters-with-javascript/11582513#11582513
        function getURLParameter(name) {
        return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search)||[,""])[1].replace(/\+/g, '%20'))||null
        }
        var url = getURLParameter('url');
        if (!url) url = 'https://soundcloud.com/jacob-kauble/defilade';
        
        var sketch = function(s) {
            
            var canvas;
            var thumbnail;
            var freq;
            
            s.preload = function() {
                s.background(0);
                song = s.loadSound(sound.stream_url + '?client_id=' + client_id);
            }
            
            s.setup = function() {
                canvas = s.createCanvas(s.windowWidth, s.windowHeight);
                if (sound.artwork_url) thumbnail = s.loadImage(sound.artwork_url);
                else thumbnail = "";
                
                amp = new p5.Amplitude(.25);
                fft = new p5.FFT(.25, 64);
                freq = fft.analyze();
                
                song.play();
            }
            
            s.mousePressed = function() {
                var fs = s.fullscreen();
                s.fullscreen(!fs);
            }
            
            s.draw = function() {
                var level = amp.getLevel();
                freq = fft.analyze();
                
                /* BACKGROUND */
                s.background(0);
                
                s.push();
                
                /* SPECTRUM */
                s.noStroke();
                s.rotate(0);
                s.fill(255);
                
                var x_scale = 0.75;
                var y_scale = 0.33;
                s.translate((s.width - (s.width * x_scale)) / 2, (s.height - (s.height * y_scale)) / 2 - s.height * 0.25);
                s.scale(0.75, 0.33);
                
                var bands = 64;
                var high_end = 17000;
                var length = high_end / bands;
                var margin = 2;
                for (var i = 0; i < bands; i += 1) {
                    var x = s.map(i, 1, bands, 0, s.width);
                    var h = -s.height + s.map(fft.getEnergy(i * length + 1, i * length + length), 0, 255, s.height, 0);
                    s.rect(x + margin, s.height, (s.width / bands) - margin * 2, h);
                }
                
                s.pop();
                s.scale(1);
                
                var artwork_width = 100 + 10; // 14 pixels for padding
                var x = (s.width - (s.width * x_scale)) / 2 + artwork_width;
                var y = (s.height - (s.height * y_scale)) / 2 + s.height / 8;
                var lineheight = 30;
                
                /* TRACK DETAILS */
                s.fill(255);
                s.textFont('Open Sans');
                
                // thumbnail - set blend mode to show white as transparent
                //s.blendMode(s.MULTIPLY);
                if (thumbnail !== "") s.image(thumbnail, x - artwork_width - 14, y);
                else x = (s.width - (s.width * x_scale)) / 2
                s.blendMode(s.BLEND);
                
                // author
                s.stroke(255);
                s.strokeWeight(3);
                s.textSize(50);
                s.textLeading(30);
                y += lineheight + 24;
                s.text(sound.user.username.toUpperCase(), x, y);
                
                // title
                s.noStroke();
                y += lineheight;
                s.textSize(30);
                s.text(sound.title.toUpperCase(), x, y);
                // also available: sound.created_at, sound.label_name, sound.permalink_url, sound.tag_list
                // https://developers.soundcloud.com/docs/api/reference#tracks
            }
            
            s.windowResized = function() {
                s.background(0);
                s.resizeCanvas(s.windowWidth, s.windowHeight);
            }
        };
        
        // call SoundCloud API
        SC.initialize({
            client_id: client_id
        });
        
        SC.get('/resolve', {
            url: url
        }, function(data) {
            sound = data;
            myp5 = new p5(sketch);
        });
    </script>

</head>

<body style="padding:0;margin:0;overflow:hidden;">

</body>

</html>