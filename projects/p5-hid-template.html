<!doctype html>
<html lang="en">

<head>
    <link href='//fonts.googleapis.com/css?family=Nothing+You+Could+Do' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
    <script src="//cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.5/p5.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.5/addons/p5.sound.min.js"></script>
    <script src="//connect.soundcloud.com/sdk.js"></script>
    <script>
        var myp5;
        var sound;
        var client_id = 'ea6d4c6a6f367767516c9221a30c2ced';
        var url = 'https://soundcloud.com/ugotsta/those-are-not-goblins';
        var txt = "Hidden in Darkness";

        var sketch = function(s) {

            var x = 100;
            var y = 100;
            var t = [];
            var canvas;
            var thumbnail;
            var freq;
            var grad1, grad2;
            var chars = "',.;-/`!~|/";

            s.rand = function(low, high) {
                return Math.floor((Math.random() * high) + low);
            };

            s.preload = function() {
                s.background(0);
                song = s.loadSound(sound.stream_url + '?client_id=' + client_id);
            }

            s.setup = function() {
                canvas = s.createCanvas(s.windowWidth, s.windowHeight);
                if (sound.artwork_url) thumbnail = s.loadImage(sound.artwork_url);
                else thumbnail = "";

                // setup gradient
                var x = y = 0;
                grad1 = s.createImage(s.width, s.height);
                grad1.loadPixels();
                var c1 = s.color(150, 150, 150, 100);
                var c2 = s.color(0, 0, 0, 255);

                for (i = 0; i < grad1.width; i++) {
                    var inter = s.map(i, 0, grad1.height, 0, 1);
                    var c = s.lerpColor(c1, c2, inter);
                    for (j = 0; j < grad1.height; j++) {
                        grad1.set(i, j, c);
                    }
                }
                grad1.updatePixels();

                amp = new p5.Amplitude(.25);
                fft = new p5.FFT(.25, 64);
                freq = fft.analyze();
                for (var i = 0; i < freq.length; i++) {
                    t.push(0);
                }

                song.play();
                s.background(0);
            }

            s.mousePressed = function() {
                if (s.mouseX > 0 && s.mouseX < 100 && s.mouseY > 0 && s.mouseY < 100) {
                    var fs = s.fullscreen();
                    s.fullscreen(!fs);
                }
            }

            s.draw = function() {
                var level = amp.getLevel();
                freq = fft.analyze();

                // Get levels
                var bass = fft.getEnergy('bass');
                var lowMid = fft.getEnergy('lowMid');
                var mid = fft.getEnergy('mid');
                var highMid = fft.getEnergy('highMid');
                var treble = fft.getEnergy('treble');

                /* BACKGROUND */
                var rnd = Math.floor((Math.random() * 50) + 1);
                s.background(255 - rnd, 255 - rnd, 255 - rnd);

                s.push();

                // GRADIENT
                s.rotate(1.38);
                s.scale(1, 3);
                s.image(grad1, -200, -600);

                s.pop();

                s.push();

                /* CHARRED GRASS */
                var text_x = -100, text_y = 500;
                s.rotate(-0.19);
                s.fill(0, 0, 0, 255);
                s.noStroke();
                s.scale(1);
                s.textSize(20);
                s.textFont('Nothing You Could Do');
                var str = '';
                for (var i = 0; i < 400; i++) {
                    str += chars[s.rand(0, chars.length)];
                }
                s.text(str, text_x, text_y);

                // other random characters
                s.noStroke();
                for (var i = 0; i < 20; i++) {
                    s.textSize(s.rand(10, lowMid / 3));
                    s.fill(0, 0, 0, s.rand(20, 200));
                    s.text(chars[s.rand(0, chars.length)], s.rand(text_x, s.width), text_y);
                }
                s.pop();

                /* TEXT */
                s.fill(0, 0, 0, 230);
                s.scale(1 + (bass / 255) / 5);
                var bass_translate = (bass / 255) * 150;
                s.translate(-bass_translate / 3, -bass_translate);
                s.rotate(-0.17);
                s.textSize(100);
                s.noStroke();
                s.textFont('Nothing You Could Do');
                var text = txt;
                // change a letter case if level is past a threshold
                if (highMid > 100) {
                    var newstring = '';
                    for (var i = 0; i < text.length; i++) {
                        if (Math.random() > 0.95) {
                            if (Math.random() > 0.5) newstring += text[i].toLowerCase();
                            else newstring += text[i].toUpperCase();
                        }
                        else newstring += text[i];
                    }
                    text = newstring;
                }
                // reverse string if past higher threshold
                if (level > 0.3) text = text.split('').reverse().join('');
                s.text(text, text_x + 150, text_y + 50);

                // reset transforms
                s.translate(+bass_translate / 4, +bass_translate);
                s.scale(1 - (bass / 255) / 5);
                s.rotate(+0.17);

                /* TRACK DETAILS */
                s.scale();
                s.translate();
                s.stroke(0, 0, 0, 100);
                s.strokeWeight(2);
                s.fill(0);
                s.textFont('Nothing You Could Do');
                s.textSize(18);
                var lineheight = 20,
                    x = 160,
                    y = 146;

                // thumbnail - set blend mode to show white as transparent
                s.blendMode(s.MULTIPLY);
                if (thumbnail !== "") s.image(thumbnail, 50, 130);
                else x = 50
                s.blendMode(s.BLEND);

                // title
                s.text(sound.title, x, y);
                s.textFont('Inconsolata');
                s.textSize(14);
                // post date
                y += lineheight;
                if (sound.created_at)
                    s.text(sound.created_at, x, y);
                // label name or tags
                y += lineheight;
                if (sound.label_name) s.text(sound.label_name, x, y);
                else s.text(sound.tag_list, x, y);
                // permalink
                s.textSize(16);
                y += lineheight * 2;
                if (sound.permalink_url)
                    s.text(sound.permalink_url, x, y);

                // SCRATCHES
                s.fill(0);
                s.translate(0, 0);
                s.stroke(0);
                s.strokeWeight(0.5);
                s.rotate(treble);
                s.textSize(Math.floor(s.rand(8, treble)));
                s.tint(255, s.rand(0, 255));
                s.text(chars[s.rand(0, chars.length)], s.rand(0, s.width), s.rand(0, s.height));
                s.rotate(-treble);

                /* SPECTRUM */
                s.translate(50, 50);
                s.scale(0.92, 0.1);
                s.noStroke();
                s.rotate(0);
                s.tint(0, 0, 0, 40);
                s.fill(0, 0, 0, 255);
                for (var i = 0; i < freq.length; i++) {
                    var x = s.map(i, 0, freq.length, 0, s.width);
                    var h = -s.height + s.map(freq[i], 0, 255, s.height, 0);
                    s.rect(x, s.height, s.width / freq.length, h);
                }
                // border and fill
                s.fill(255, 255, 255, 40);
                s.stroke(255);
                s.strokeWeight(1);
                s.rect(0, 0, s.width, s.height);

            }

            s.windowResized = function() {
                s.background(0);
                //s.canvas.resize(s.windowWidth, s.windowHeight);
            }
        };

        // call SoundCloud API
        SC.initialize({
            client_id: client_id
        });

        SC.get('/resolve', {
            url: url
        }, function(data) {
            sound = data;
            myp5 = new p5(sketch);
        });
    </script>

</head>

<body style="padding:0;margin:0;overflow:hidden;">

</body>

</html>