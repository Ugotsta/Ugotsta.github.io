<!doctype html>
<html lang="en">

<head>
    <link href='http://fonts.googleapis.com/css?family=Nothing+Yout+Could+Do' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
    <script src="//cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.5/p5.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/p5.js/0.4.5/addons/p5.sound.min.js"></script>
    <script src="//connect.soundcloud.com/sdk.js"></script>
    <script>
        var p5sc_instance;
        var sound;
        var client_id = 'ea6d4c6a6f367767516c9221a30c2ced';
        
        // from here: http://stackoverflow.com/questions/11582512/how-to-get-url-parameters-with-javascript/11582513#11582513
        function getURLParameter(name) {
            return decodeURIComponent((new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(location.search) || [, ""])[1].replace(/\+/g, '%20')) || null
        }
        var url = getURLParameter('url');
        if (!url) url = 'https://soundcloud.com/ugotsta/those-are-not-goblins';
        var txt = getURLParameter('txt');
        if (!txt) txt = 'Hidden in Darkness';
        
        var p5sc = function(s) {
            
            var canvas;
            var thumbnail;
            var freq;
            var x, y, x_scale, y_scale, spectrum_width, spectrum_height;
            
            s.preload = function() {
                s.background(0);
                song = s.loadSound(sound.stream_url + '?client_id=' + client_id);
            };
            
            s.setup = function() {
                canvas = s.createCanvas(s.windowWidth, s.windowHeight);
                if (sound.artwork_url) thumbnail = s.loadImage(sound.artwork_url);
                else thumbnail = "";
                
                amp = new p5.Amplitude(.25);
                fft = new p5.FFT(.1, 64);
                
                song.play();
            };
            
            s.mousePressed = function() {
                var fs = s.fullscreen();
                s.fullscreen(!fs);
            };
            
            s.text_clean = function(t) {
                if(!t) return " ";
                if(t.length > 30)
                    t = t.substring(0, 29) + " ...";
                return t.toString();
            };
            
            s.draw = function() {
                var level = amp.getLevel();
                freq = fft.analyze();
                
                x_scale = 0.95; // 85% of s.width
                y_scale = 0.33; // 33% of x.height
                x = (s.width - (s.width * x_scale)) / 2;
                y = (s.height - (s.height * y_scale)) + s.height * (y_scale / 4);
                spectrum_width = s.width * x_scale;
                spectrum_height = (s.height * y_scale);
                
                /* BACKGROUND */
                s.draw_background();
                
                /* SPECTRUM */
                s.draw_spectrum();
                
                /* TRACK DETAILS */
                s.draw_details();
            };
            
            s.draw_background = function() {
                var highMid = fft.getEnergy('highMid');
                var random = s.random(0, 3 + s.map(highMid, 0, 255, 0, 20));
                s.background(random);
                var c1 = s.color(255, 255, 255, 245);
                var c2 = s.color(0, 0, 0, 2);
                s.setGradient(0, 0, s.width, y, c1, c2);
                c1 = s.color(0, 0, 0, 0);
                c2 = s.color(0, 0, 0, 3);
                s.fill(0, 0, 0, 255);
                s.rect(0, y, s.width, s.height);
                //s.setGradient(0, y, s.width, s.height, c1, c2);
            };
            
            s.setGradient = function(grad_x, grad_y, grad_w, grad_h, c1, c2) {
                s.noFill();
                for (var i = grad_y; i <= grad_y + grad_h; i++) {
                    var inter = s.map(i, grad_y, grad_y + grad_h, 0, 1);
                    var c = s.lerpColor(c1, c2, inter);
                    s.stroke(c);
                    s.line(grad_x, i, grad_x + grad_w, i);
                }
            };
            
            s.draw_spectrum = function() {
                s.noStroke();
                s.fill(0, 0, 0, 255);
                
                var bands = 64;
                var l = 17000 / bands; // width per band, max frequency of 17000
                var margin = 4;
                for (var i = 0; i < bands; i += 1) {
                    var x_pos = s.map(i, 0, bands, x, x + spectrum_width);
                    var h = -(spectrum_height) + s.map((function() {
                        var from = i * l + 1;
                        var to = from + l;
                        // TODO: find proper way to accommodate low frequency energy
                        var adj = 1;
                        if (i == 0) adj = 0.5;
                        if (i == 1) adj = 0.75;
                        return fft.getEnergy(from, to) * adj;
                    })(), 0, 255, spectrum_height, 0);
                    s.rect(x_pos, y, (spectrum_width / bands) - margin, h);
                }
                
                /* CHARRED GRASS */
                grass_size = 60;
                s.fill(0, 0, 0, 255);
                s.noStroke();
                s.textSize(grass_size);
                s.textFont('Nothing You Could Do');
                var str = '';
                var chars = "',.;/:!~|/";
                for (i = 0; i < 200; i++) {
                    var random = s.random(0, chars.length);
                    str += chars[Math.floor(random)];
                }
                s.text(str, 0, y + grass_size / 4);
                
            };

            s.draw_details = function() {
                //var padding = 28;
                x = (s.width - (s.width * x_scale)) / 2;
                y = x;
                var artwork_size = 100 + 10; // 10 pixels for padding
                var lineheight = 30;

                s.fill(0);
                //s.textFont('Nothing You Could Do');
                s.textFont('Inconsolata');

                // thumbnail - set blend mode to show white as transparent
                s.blendMode(s.MULTIPLY);
                if (thumbnail !== "") {
                    s.image(thumbnail, x, y);
                    x += artwork_size;
                }
                s.blendMode(s.BLEND);

                // author
                s.noStroke();
                s.textSize(50);
                s.textLeading(30);
                y += lineheight + 24;
                s.text(s.text_clean(sound.title), x, y);

                // title
                s.noStroke();
                y += lineheight;
                s.textSize(30);
                s.text(s.text_clean(sound.label_name), x, y);
                
                // right-side
                x = s.width - ((s.width - (s.width * x_scale)) / 2);
                //x = s.width - padding;
                y = lineheight * 2;
                s.textSize(30);
                s.textAlign(s.RIGHT);
                s.text(s.text_clean(sound.created_at), x, y);
                y += lineheight;
                s.text(s.text_clean(sound.tag_list), x, y);
                s.textAlign(s.LEFT);
                
                // also available: sound.created_at, sound.label_name, sound.permalink_url, sound.tag_list
                // https://developers.soundcloud.com/docs/api/reference#tracks
                
                /* "Hidden in Darkness" */
                var bass = fft.getEnergy('bass');
                var lowMid = fft.getEnergy('lowMid');
                var mid = fft.getEnergy('mid');
                
                var text_size = 100;
                
                y = (s.height - (s.height * y_scale)) + s.height * (y_scale / 4);
                x = s.width / 2;
                
                s.fill(0);
                var scale = s.map(bass, 0, 255, 0, 0.5);
                var bass_translate = (bass / 255) * 260;
                s.translate(0, -bass_translate);
                s.textSize(text_size);
                s.noStroke();
                s.textFont('Nothing You Could Do');
                var text = txt;
                // change a letter case if level is past a threshold
                if (mid > 100) {
                    var newstring = '';
                    for (var i = 0; i < text.length; i++) {
                        if (Math.random() > 0.95) {
                            if (Math.random() > 0.5) newstring += text[i].toLowerCase();
                            else newstring += text[i].toUpperCase();
                        }
                        else newstring += text[i];
                    }
                    text = newstring;
                }
                // reverse string if past higher threshold
                if (lowMid > 245) text = text.split('').reverse().join('');
                s.textAlign(s.CENTER);
                s.text(text, x, y);

                // reset transforms
                s.translate(0, +bass_translate);
                
                // SCRATCHES
                s.fill(0, 0, 0, 255);
                s.translate(0, 0);
                s.stroke(0);
                s.strokeWeight(0.5);
                s.textFont('Nothing You Could Do');
                var treble = fft.getEnergy('treble');
                s.rotate(s.map(treble, 0, 255, 0, 1));
                s.textSize(Math.floor(s.random(8, treble)));
                s.tint(255, Math.floor(s.random(0, 255)));
                var chars = "',.;-/`!~|/";
                var random_x = Math.floor(s.random(0, s.width));
                var random_y = Math.floor(s.random(0, s.height));
                s.text(chars[Math.floor(s.random(0, chars.length))], random_x, random_y);
                s.rotate(-treble);
                
            };

            s.windowResized = function() {
                s.resizeCanvas(s.windowWidth, s.windowHeight);
                s.draw_background();
            };
        };

        // call SoundCloud API
        SC.initialize({
            client_id: client_id
        });

        SC.get('/resolve', {
            url: url
        }, function(data) {
            sound = data;
            p5sc_instance = new p5(p5sc);

        });
    </script>

</head>

<body style="padding:0;margin:0;overflow:hidden;">

</body>

</html>